(window.webpackJsonp=window.webpackJsonp||[]).push([[26],{575:function(s,n,t){"use strict";t.r(n);var e=t(6),a=Object(e.a)({},(function(){var s=this,n=s.$createElement,t=s._self._c||n;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[s._v("最近因为公司项目需要搭建一个私服 npm，安排我来研究，这两天也踩了不少坑，于是记录下踩坑经历，避免小伙伴们踩坑。")]),s._v(" "),t("h2",{attrs:{id:"私服-npm-能做什么"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#私服-npm-能做什么"}},[s._v("#")]),s._v(" 私服 npm 能做什么？")]),s._v(" "),t("p",[s._v("如果一个公司的项目非常多，而且有很多的方法、组件、api都是可以共用的。如果没有私服 npm，那么我们将不断的复制粘贴这些代码到各个项目中，一旦其中的某一处需要修改，那么所有的项目都需要改一遍。")]),s._v(" "),t("p",[s._v("更好地维护这些公共代码，比较好的处理方式是将这些公共代码封装成一个个 npm 包，但是我们又不能将公司的代码发布到外网的 npm 中，所以私服 npm 就能够很好地帮助我们解决这一问题。")]),s._v(" "),t("h2",{attrs:{id:"安装-nexus"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装-nexus"}},[s._v("#")]),s._v(" 安装 Nexus")]),s._v(" "),t("p",[s._v("由于之前学习 docker 的时候安装了 Nexus，小伙伴们可以参考之前的文章 "),t("a",{attrs:{href:"https://mp.weixin.qq.com/s/P8625h1nh6Zd-viRRSqrNg",target:"_blank",rel:"noopener noreferrer"}},[s._v("使用 Nexus 创建 Docker 仓库"),t("OutboundLink")],1),s._v("，这里不再过多赘述。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("$ docker run -d --name nexus3 --restart"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("always "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8081")]),s._v(":8081 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8082")]),s._v(":8082 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    -v nexus-data:/nexus-data "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    sonatype/nexus3\nUnable to "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("find")]),s._v(" image "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'sonatype/nexus3:latest'")]),s._v(" locally\nlatest: Pulling from sonatype/nexus3\nc65691897a4d: Pull complete\n641d7cc5cbc4: Pull complete\nc508b13320cd: Pull complete\n79e3bf9d3132: Pull complete\nDigest: sha256:2c33632ccd8f8c5f9023a3d7f5f541e271833e402219f8c5a83a29d1721457ca\nStatus: Downloaded newer image "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" sonatype/nexus3:latest\nf637e039214978f8aac41e621e51588bd8cd8438055498c4060fbaf87799e64f\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("p",[s._v("如果你已经安装了 docker，可以使用上面的命令安装并启动 Nexus 服务。否则需要到官网 https://www.sonatype.com/download-oss-sonatype 下载 Nexus。因为使用 docker 更加方便快捷，这里更推荐使用 docker 的方式启动 Nexus 服务。")]),s._v(" "),t("p",[s._v("命令执行完后，用浏览器打开 "),t("code",[s._v("http://localhost:8081")]),s._v(" 即可看到 Nexus 的管理页面。点击右上角 "),t("code",[s._v("Sign In")]),s._v(" 登录，管理员账号 "),t("code",[s._v("admin")]),s._v("，初始密码可以根据提示进入容器内查看。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("$ docker "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" -it f637 /bin/bash\nbash-4.4$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /nexus-data/admin.password\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("其中 f637 为容器 id，需要根据启动 nexus 的容器 id 进行修改。")]),s._v(" "),t("h2",{attrs:{id:"创建-npm-仓库"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#创建-npm-仓库"}},[s._v("#")]),s._v(" 创建 npm 仓库")]),s._v(" "),t("p",[s._v("打开"),t("code",[s._v("设置 -> repositories")]),s._v(" 页面，点击 "),t("code",[s._v("Create repository")]),s._v(" 按钮。")]),s._v(" "),t("p",[t("img",{attrs:{src:"/imgs/%E5%89%8D%E7%AB%AF/4.png",alt:"Create repository"}})]),s._v(" "),t("h3",{attrs:{id:"先创建-npm-proxy-仓库-即代理仓库"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#先创建-npm-proxy-仓库-即代理仓库"}},[s._v("#")]),s._v(" 先创建 "),t("code",[s._v("npm(proxy)")]),s._v(" 仓库，即代理仓库")]),s._v(" "),t("p",[s._v("填入仓库名以及代理地址，代理地址可使用 npm 官方镜像地址 https://registry.npmjs.org")]),s._v(" "),t("p",[t("img",{attrs:{src:"/imgs/%E5%89%8D%E7%AB%AF/5.png",alt:"npm(proxy)"}})]),s._v(" "),t("p",[s._v("完成后点击底部 "),t("code",[s._v("Creaete repository")]),s._v(" 完成创建。")]),s._v(" "),t("h3",{attrs:{id:"创建-npm-hosted-仓库-即私服仓库"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#创建-npm-hosted-仓库-即私服仓库"}},[s._v("#")]),s._v(" 创建 "),t("code",[s._v("npm(hosted)")]),s._v(" 仓库，即私服仓库")]),s._v(" "),t("p",[t("img",{attrs:{src:"/imgs/%E5%89%8D%E7%AB%AF/6.png",alt:"npm(hosted)"}})]),s._v(" "),t("p",[s._v("输入仓库名即可点击底部 "),t("code",[s._v("Creaete repository")]),s._v(" 完成创建。")]),s._v(" "),t("h3",{attrs:{id:"创建-npm-group-仓库-npm-组"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#创建-npm-group-仓库-npm-组"}},[s._v("#")]),s._v(" 创建 "),t("code",[s._v("npm(group)")]),s._v(" 仓库，npm 组")]),s._v(" "),t("p",[s._v("为什么要使用 "),t("code",[s._v("npm(group)")]),s._v(" ？")]),s._v(" "),t("p",[s._v("当我们从 "),t("code",[s._v("npm(group)")]),s._v(" 这个仓库安装 npm 包时，首先会查看该仓库中是否存在，不存在时则会使用代理仓库到官方仓库进行下载。")]),s._v(" "),t("p",[t("img",{attrs:{src:"/imgs/%E5%89%8D%E7%AB%AF/7.png",alt:"npm(group)"}})]),s._v(" "),t("p",[s._v("创建 "),t("code",[s._v("npm(group)")]),s._v(" 需要填写仓库名，然后将 "),t("code",[s._v("npm(proxy)")]),s._v(" 和 "),t("code",[s._v("proxy(hosted)")]),s._v(" 设置为成员即可，点击底部 "),t("code",[s._v("Creaete repository")]),s._v(" 完成创建。")]),s._v(" "),t("h2",{attrs:{id:"验证私服-npm"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#验证私服-npm"}},[s._v("#")]),s._v(" 验证私服 npm")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" vue --registry"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("http://localhost:8081/repository/npm-group/\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" ERR"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" code E401\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" ERR"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("401")]),s._v(" Unauthorized: vue@latest\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" ERR"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" A complete log of this run can be found in:\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" ERR"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("     /Users/admin/.npm/_logs/2019-12-24T08_33_14_088Z-debug.log\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("可以看到出现了 401 未授权的错误，因为我们的 npm 没有登录私服。")]),s._v(" "),t("p",[s._v("原有的 npm 是可以不登录进行安装 npm 包的，所以我们的私服也需要改成允许匿名访问的。")]),s._v(" "),t("p",[t("strong",[s._v("打开设置页面 "),t("code",[s._v("Security -> Anonymous")]),s._v("，勾选 "),t("code",[s._v("Allow anonymous users to access the server")]),s._v(" 即可，点击 "),t("code",[s._v("save")]),s._v(" 保存。")]),s._v("（网上的文章基本都跳过该步骤）")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" vue --registry"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("http://localhost:8081/repository/npm-group/\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" notice created a lockfile as package-lock.json. You should commit this file.\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" WARN npm-test@1.0.0 No description\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" WARN npm-test@1.0.0 No repository field.\n\n+ vue@2.6.11\nadded "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" package from "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" contributor "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(".944s\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("可以看到这次就安装成功了。")]),s._v(" "),t("p",[s._v("但是每次都需要指定 "),t("code",[s._v("--registry")]),s._v(" 也太麻烦了，我们可以使用 "),t("code",[s._v("npm config set registry http://localhost:8081/repository/npm-group/")]),s._v(", 将 npm 默认的镜像改成我们私服的镜像。这样我们就不需要每次都指定镜像源了。")]),s._v(" "),t("p",[s._v("直接修改默认的镜像源也不够方便，因为发包的时候使用的镜像源是 "),t("code",[s._v("http://localhost:8081/repository/npm-hosted/")]),s._v("。最好的方式是写一个自己的 "),t("code",[s._v("cnpm")]),s._v("。")]),s._v(" "),t("p",[s._v("因此我写了一个为私服 npm 使用工具 "),t("code",[s._v("fnpm")]),s._v(" 在 github，小伙伴们可以到 https://github.com/AD-feiben/fnpm 上克隆。在使用上与 "),t("code",[s._v("npm")]),s._v(" 一样，但是会从私服上拉取 npm 包，发布包也只会发布到私服中。")]),s._v(" "),t("h2",{attrs:{id:"使用-fnmp"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用-fnmp"}},[s._v("#")]),s._v(" 使用 fnmp")]),s._v(" "),t("p",[s._v("首先将 fnpm 克隆到本地")]),s._v(" "),t("div",{staticClass:"language-git line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-git"}},[t("code",[t("span",{pre:!0,attrs:{class:"token command"}},[s._v("$ git clone git@github.com:AD-feiben/fnpm.git")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("根据私服 npm 地址修改 "),t("code",[s._v("lib/config.js")]),s._v(" 中 "),t("code",[s._v("fnpmRegistry")]),s._v("、"),t("code",[s._v("fnpmHostedRegistry")]),s._v(" 对应的地址即可。")]),s._v(" "),t("p",[s._v("将 fnpm 发布到私服，参考下文使用 npm 命令发布包。")]),s._v(" "),t("p",[s._v("使用 "),t("code",[s._v("npm install fnpm --registry=http://localhost:8081/repository/npm-group/ -g")]),s._v(" 下载 fnpm。")]),s._v(" "),t("p",[s._v("接下就可以使用 fnpm 了。")]),s._v(" "),t("h2",{attrs:{id:"发布-npm-包到私服"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#发布-npm-包到私服"}},[s._v("#")]),s._v(" 发布 npm 包到私服")]),s._v(" "),t("p",[s._v("首先登录私服 npm")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" login --registry"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("http://localhost:8081/repository/npm-hosted/\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# or")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果安装了 fnpm")]),s._v("\n$ fnpm login\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("使用 "),t("code",[s._v("publish")]),s._v(" 命令发布")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" publish --registry"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("http://localhost:8081/repository/npm-hosted/\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# or")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果安装了 fnpm")]),s._v("\n$ fnpm publish\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("如果文中有说的不对的地方，欢迎留言指出改正，也欢迎留言讨论。")]),s._v(" "),t("hr"),s._v(" "),t("p",[s._v("如果还有其他疑问，欢迎大家扫码关注我的公众号【前端develop】给我留言。")]),s._v(" "),t("p",[t("img",{attrs:{src:"/imgs/qrcode.png",alt:"前端develop"}})])])}),[],!1,null,null,null);n.default=a.exports}}]);